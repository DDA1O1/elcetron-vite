# .github/workflows/release.yml

name: Release Electron App

on:
  # Triggers the workflow on pushes that create a tag matching the pattern v*.*.* (e.g., v1.0.0, v1.2.3)
  push:
    tags:
      - 'v*.*.*'

jobs:
  # Job to build for Windows x64
  build-windows-x64:
    runs-on: windows-latest # Use a Windows runner for Squirrel/EXE build
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Or your preferred Node version
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # Explicitly make for win32 x64 using the configured Squirrel maker
      - name: Build Windows x64 (Make)
        run: npm run make -- --platform=win32 --arch=x64

      # Upload the contents of the make output directory for x64
      - name: Upload Windows x64 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-artifact # Unique artifact name for x64 build
          path: out/make/**/* # Upload all files within the make output dir

  # Job to build for Windows ARM64
  build-windows-arm64:
    runs-on: windows-latest # Still needs a Windows runner
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Or your preferred Node version
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # Explicitly make for win32 arm64 using the configured Squirrel maker
      - name: Build Windows arm64 (Make)
        run: npm run make -- --platform=win32 --arch=arm64 # Target arm64

      # Upload the contents of the make output directory for ARM64
      - name: Upload Windows arm64 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-arm64-artifact # Unique artifact name for ARM64 build
          path: out/make/**/* # Upload all files within the make output dir

  # Job to build for Linux x64 and arm64
  build-linux:
    runs-on: ubuntu-latest # Use a Linux runner for Deb builds
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Or your preferred Node version
          cache: 'npm'

      # Install dependencies needed for building arm64 deb on x64 runner
      - name: Install Linux Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends dpkg fakeroot

      - name: Install Project Dependencies
        run: npm ci

      # Explicitly make for linux x64 using the configured Deb maker
      - name: Build Linux x64 (Make)
        run: npm run make -- --platform=linux --arch=x64

      # Explicitly make for linux arm64 using the configured Deb maker
      - name: Build Linux arm64 (Make)
        run: npm run make -- --platform=linux --arch=arm64

      # Upload the contents of the make output directory (contains both .deb files)
      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: out/make/**/*

  # Job to create the GitHub Release and upload all built artifacts
  release:
    runs-on: ubuntu-latest
    # Depends on all three build jobs completing successfully
    needs: [build-windows-x64, build-windows-arm64, build-linux]
    permissions:
      contents: write # Needed to create releases and upload assets

    steps:
      - name: Checkout Repository # Needed to get tag info
        uses: actions/checkout@v4

      # Create a directory to download all artifacts into
      - name: Create Staging Directory
        run: mkdir staging

      # Download the artifact from the Windows x64 build job
      - name: Download Windows x64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-x64-artifact
          path: staging/windows-x64

      # Download the artifact from the Windows ARM64 build job
      - name: Download Windows arm64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-arm64-artifact
          path: staging/windows-arm64

      # Download the artifact from the Linux build job
      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-artifacts
          path: staging/linux

      # --- NEW STEPS: Rename Windows artifacts to avoid name collisions ---
      - name: Rename Windows x64 Artifacts
        # Renames Setup.exe and the nupkg file for the x64 build
        # Uses standard Linux commands available on the ubuntu runner
        # Uses || true to prevent failure if a file (e.g., RELEASES) doesn't exist, though Setup.exe and nupkg should
        run: |
          cd staging/windows-x64
          PACKAGE_VERSION=$(ls *.nupkg | sed -n 's/.*-\([0-9.]*\)-full\.nupkg/\1/p')
          if [[ -n "$PACKAGE_VERSION" ]]; then
            mv --backup=numbered ./*-$PACKAGE_VERSION-full.nupkg ./my-app-$PACKAGE_VERSION-x64-full.nupkg || true
            mv --backup=numbered ./my-app-$PACKAGE_VERSION\ Setup.exe ./my-app-$PACKAGE_VERSION-x64-Setup.exe || true
            # Optional: Rename RELEASES if needed, though often identical is fine
            # mv --backup=numbered ./RELEASES ./RELEASES-x64 || true
          else
            echo "Warning: Could not determine package version for x64 renaming."
          fi
          cd ../..

      - name: Rename Windows arm64 Artifacts
        # Renames Setup.exe and the nupkg file for the arm64 build
        run: |
          cd staging/windows-arm64
          PACKAGE_VERSION=$(ls *.nupkg | sed -n 's/.*-\([0-9.]*\)-full\.nupkg/\1/p')
          if [[ -n "$PACKAGE_VERSION" ]]; then
            mv --backup=numbered ./*-$PACKAGE_VERSION-full.nupkg ./my-app-$PACKAGE_VERSION-arm64-full.nupkg || true
            mv --backup=numbered ./my-app-$PACKAGE_VERSION\ Setup.exe ./my-app-$PACKAGE_VERSION-arm64-Setup.exe || true
            # Optional: Rename RELEASES if needed
            # mv --backup=numbered ./RELEASES ./RELEASES-arm64 || true
          else
            echo "Warning: Could not determine package version for arm64 renaming."
          fi
          cd ../..
      # --- END OF NEW STEPS ---

      # List final files in staging for verification (optional)
      - name: List final staging files
        run: ls -R staging

      # Use a dedicated action to create the release and upload artifacts
      - name: Create GitHub Release and Upload Artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          # Upload all files found within the staging directory and its subdirectories
          # The renamed files will now be uploaded with their unique names
          files: staging/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}